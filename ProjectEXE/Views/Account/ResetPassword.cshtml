@model ProjectEXE.ViewModel.AccountViewModel.ResetPasswordViewModel
@{
    ViewData["Title"] = "Đặt lại mật khẩu";
}

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <!-- Hiển thị thông báo lỗi từ TempData -->
            @if (TempData["Warning"] != null)
            {
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    @TempData["Warning"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    @TempData["Error"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Đặt lại mật khẩu</h3>
                </div>
                <div class="card-body">
                    <form asp-action="ResetPassword" method="post" id="resetPasswordForm">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                        <input type="hidden" asp-for="Email" />
                        <input type="hidden" asp-for="Token" />

                        <div class="mb-3">
                            <label asp-for="Password" class="form-label">Mật khẩu mới</label>
                            <input asp-for="Password" class="form-control" placeholder="Nhập mật khẩu mới (tối thiểu 6 ký tự)" autocomplete="new-password" />
                            <span asp-validation-for="Password" class="text-danger"></span>
                            <div class="form-text">Mật khẩu phải có ít nhất 6 ký tự</div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ConfirmPassword" class="form-label">Xác nhận mật khẩu</label>
                            <input asp-for="ConfirmPassword" class="form-control" placeholder="Nhập lại mật khẩu mới" autocomplete="new-password" />
                            <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary" id="submitBtn">Đặt lại mật khẩu</button>
                        </div>
                    </form>
                </div>
                <div class="card-footer text-center">
                    <p class="mb-0"><a asp-action="Login">Quay lại trang đăng nhập</a></p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        $(document).ready(function () {
            console.log("Reset password page loaded");

            // Custom validation cho confirm password
            $('#resetPasswordForm').on('submit', function (e) {
                var password = $('#Password').val();
                var confirmPassword = $('#ConfirmPassword').val();

                console.log("Password:", password);
                console.log("Confirm Password:", confirmPassword);

                // Clear previous errors
                $('.text-danger').text('');

                var isValid = true;

                // Validate password length
                if (password.length < 6) {
                    $('span[data-valmsg-for="Password"]').text('Mật khẩu phải có ít nhất 6 ký tự');
                    isValid = false;
                }

                // Validate confirm password
                if (password !== confirmPassword) {
                    $('span[data-valmsg-for="ConfirmPassword"]').text('Mật khẩu và xác nhận mật khẩu không khớp');
                    isValid = false;
                }

                if (!isValid) {
                    e.preventDefault();
                    return false;
                }

                // Disable submit button to prevent double submission
                $('#submitBtn').prop('disabled', true).text('Đang xử lý...');
            });

            // Real-time validation
            $('#ConfirmPassword').on('keyup blur', function () {
                var password = $('#Password').val();
                var confirmPassword = $(this).val();

                if (confirmPassword.length > 0) {
                    if (password === confirmPassword) {
                        $('span[data-valmsg-for="ConfirmPassword"]').text('').removeClass('text-danger').addClass('text-success');
                        $(this).removeClass('is-invalid').addClass('is-valid');
                    } else {
                        $('span[data-valmsg-for="ConfirmPassword"]').text('Mật khẩu không khớp').removeClass('text-success').addClass('text-danger');
                        $(this).removeClass('is-valid').addClass('is-invalid');
                    }
                }
            });

            $('#Password').on('keyup blur', function () {
                var password = $(this).val();
                var confirmPassword = $('#ConfirmPassword').val();

                if (password.length >= 6) {
                    $('span[data-valmsg-for="Password"]').text('').removeClass('text-danger').addClass('text-success');
                    $(this).removeClass('is-invalid').addClass('is-valid');
                } else if (password.length > 0) {
                    $('span[data-valmsg-for="Password"]').text('Mật khẩu phải có ít nhất 6 ký tự').removeClass('text-success').addClass('text-danger');
                    $(this).removeClass('is-valid').addClass('is-invalid');
                }

                // Recheck confirm password
                if (confirmPassword.length > 0) {
                    $('#ConfirmPassword').trigger('keyup');
                }
            });
        });
    </script>
}