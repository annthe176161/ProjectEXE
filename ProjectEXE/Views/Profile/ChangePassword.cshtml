@model ProjectEXE.ViewModel.Profile.ChangePasswordViewModel

@{
    ViewData["Title"] = "Đổi mật khẩu";
}

@section Styles {
    <link rel="stylesheet" href="~/css/changepassword.css?v=@DateTime.Now.Ticks" />
}

<div class="change-password-container">
    <div class="change-password-wrapper">
        <div class="change-password-content">
            <!-- Enhanced Breadcrumb -->
            <nav aria-label="breadcrumb" class="breadcrumb-nav">
                <ol class="breadcrumb-custom">
                    <li class="breadcrumb-item">
                        <a asp-controller="Home" asp-action="Index">
                            <i class="fas fa-home me-1"></i>
                            <span>Trang chủ</span>
                        </a>
                    </li>
                    <li class="breadcrumb-separator">
                        <i class="fas fa-chevron-right"></i>
                    </li>
                    <li class="breadcrumb-item">
                        <a asp-controller="Profile" asp-action="Index">
                            <i class="fas fa-user me-1"></i>
                            <span>Tài khoản</span>
                        </a>
                    </li>
                    <li class="breadcrumb-separator">
                        <i class="fas fa-chevron-right"></i>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        <i class="fas fa-key me-1"></i>
                        <span>Đổi mật khẩu</span>
                    </li>
                </ol>
            </nav>

            <!-- Main Change Password Card -->
            <div class="change-password-card">
                <!-- Card Header -->
                <div class="change-password-header">
                    <div class="header-content">
                        <div class="header-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="header-text">
                            <h2>Đổi mật khẩu</h2>
                            <p>Thay đổi mật khẩu để bảo vệ tài khoản của bạn</p>
                        </div>
                    </div>
                    <div class="security-badge">
                        <i class="fas fa-lock"></i>
                        <span>Bảo mật</span>
                    </div>
                </div>

                <!-- Card Body -->
                <div class="change-password-body">
                    <form asp-action="ChangePassword" method="post" class="password-form">
                        <!-- Validation Summary -->
                        <div asp-validation-summary="ModelOnly" class="validation-summary" role="alert">
                            <div class="validation-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="validation-content">
                                <h6>Vui lòng kiểm tra lại thông tin</h6>
                            </div>
                        </div>

                        <!-- Form Fields -->
                        <div class="form-fields">
                            <!-- Mật khẩu hiện tại -->
                            <div class="form-field-wrapper">
                                <label asp-for="CurrentPassword" class="form-label-custom">
                                    <i class="fas fa-lock label-icon"></i>
                                    <span>Mật khẩu hiện tại</span>
                                    <span class="required-indicator">*</span>
                                </label>
                                <div class="password-input-wrapper">
                                    <div class="input-icon">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                    <input asp-for="CurrentPassword" class="form-control-custom password-input" placeholder="Nhập mật khẩu hiện tại" />
                                    <button type="button" class="toggle-password" tabindex="-1">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <div class="input-border"></div>
                                </div>
                                <span asp-validation-for="CurrentPassword" class="field-validation"></span>
                            </div>

                            <!-- Mật khẩu mới -->
                            <div class="form-field-wrapper">
                                <label asp-for="NewPassword" class="form-label-custom">
                                    <i class="fas fa-key label-icon"></i>
                                    <span>Mật khẩu mới</span>
                                    <span class="required-indicator">*</span>
                                </label>
                                <div class="password-input-wrapper">
                                    <div class="input-icon">
                                        <i class="fas fa-key"></i>
                                    </div>
                                    <input asp-for="NewPassword" class="form-control-custom password-input" placeholder="Nhập mật khẩu mới" />
                                    <button type="button" class="toggle-password" tabindex="-1">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <div class="input-border"></div>
                                </div>
                                <span asp-validation-for="NewPassword" class="field-validation"></span>
                                <!-- Password Strength Indicator -->
                                <div class="password-strength">
                                    <div class="strength-bars">
                                        <div class="strength-bar"></div>
                                        <div class="strength-bar"></div>
                                        <div class="strength-bar"></div>
                                        <div class="strength-bar"></div>
                                    </div>
                                    <span class="strength-text">Độ mạnh mật khẩu</span>
                                </div>
                            </div>

                            <!-- Xác nhận mật khẩu mới -->
                            <div class="form-field-wrapper">
                                <label asp-for="ConfirmPassword" class="form-label-custom">
                                    <i class="fas fa-check-double label-icon"></i>
                                    <span>Xác nhận mật khẩu mới</span>
                                    <span class="required-indicator">*</span>
                                </label>
                                <div class="password-input-wrapper">
                                    <div class="input-icon">
                                        <i class="fas fa-check-double"></i>
                                    </div>
                                    <input asp-for="ConfirmPassword" class="form-control-custom password-input" placeholder="Nhập lại mật khẩu mới" />
                                    <button type="button" class="toggle-password" tabindex="-1">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <div class="input-border"></div>
                                </div>
                                <span asp-validation-for="ConfirmPassword" class="field-validation"></span>
                            </div>
                        </div>

                        <!-- Password Requirements -->
                        <div class="password-requirements">
                            <div class="requirements-header">
                                <i class="fas fa-info-circle"></i>
                                <h6>Yêu cầu về mật khẩu</h6>
                            </div>
                            <div class="requirements-list">
                                <div class="requirement-item" data-rule="length">
                                    <i class="fas fa-circle-check"></i>
                                    <span>Tối thiểu 6 ký tự</span>
                                </div>
                                <div class="requirement-item" data-rule="uppercase">
                                    <i class="fas fa-circle-check"></i>
                                    <span>Có ít nhất 1 chữ hoa</span>
                                </div>
                                <div class="requirement-item" data-rule="lowercase">
                                    <i class="fas fa-circle-check"></i>
                                    <span>Có ít nhất 1 chữ thường</span>
                                </div>
                                <div class="requirement-item" data-rule="number">
                                    <i class="fas fa-circle-check"></i>
                                    <span>Có ít nhất 1 số</span>
                                </div>
                                <div class="requirement-item" data-rule="special">
                                    <i class="fas fa-circle-check"></i>
                                    <span>Có ít nhất 1 ký tự đặc biệt</span>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-actions">
                            <a asp-action="Index" class="btn-secondary-custom">
                                <i class="fas fa-arrow-left me-2"></i>
                                <span>Quay lại</span>
                            </a>
                            <button type="submit" class="btn-primary-custom">
                                <i class="fas fa-shield-alt me-2"></i>
                                <span>Đổi mật khẩu</span>
                                <div class="btn-ripple"></div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Security Tips Card -->
            <div class="security-tips-card">
                <div class="tips-header">
                    <i class="fas fa-lightbulb"></i>
                    <span>Mẹo bảo mật</span>
                </div>
                <div class="tips-content">
                    <div class="tip-item">
                        <i class="fas fa-check-circle"></i>
                        <span>Sử dụng mật khẩu duy nhất cho từng tài khoản</span>
                    </div>
                    <div class="tip-item">
                        <i class="fas fa-check-circle"></i>
                        <span>Thay đổi mật khẩu định kỳ mỗi 3-6 tháng</span>
                    </div>
                    <div class="tip-item">
                        <i class="fas fa-check-circle"></i>
                        <span>Không chia sẻ mật khẩu với bất kỳ ai</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Toggle password visibility
            document.querySelectorAll('.toggle-password').forEach(function (button) {
                button.addEventListener('click', function () {
                    const input = this.previousElementSibling;
                    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                    input.setAttribute('type', type);

                    // Toggle eye icon
                    const icon = this.querySelector('i');
                    if (type === 'text') {
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                        this.classList.add('visible');
                    } else {
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                        this.classList.remove('visible');
                    }
                });
            });

            // Input focus effects
            const inputs = document.querySelectorAll('.form-control-custom');

            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    this.closest('.password-input-wrapper').classList.add('focused');
                });

                input.addEventListener('blur', function() {
                    this.closest('.password-input-wrapper').classList.remove('focused');
                    if (this.value.trim() !== '') {
                        this.closest('.password-input-wrapper').classList.add('has-value');
                    } else {
                        this.closest('.password-input-wrapper').classList.remove('has-value');
                    }
                });

                // Check initial values
                if (input.value.trim() !== '') {
                    input.closest('.password-input-wrapper').classList.add('has-value');
                }
            });

            // Password strength checker
            const newPasswordInput = document.querySelector('input[name="NewPassword"]');
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', function() {
                    checkPasswordStrength(this.value);
                    checkPasswordRequirements(this.value);
                });
            }

            function checkPasswordStrength(password) {
                const strengthBars = document.querySelectorAll('.strength-bar');
                const strengthText = document.querySelector('.strength-text');
                let strength = 0;

                // Reset bars
                strengthBars.forEach(bar => {
                    bar.classList.remove('weak', 'fair', 'good', 'strong');
                });

                if (password.length >= 6) strength++;
                if (password.match(/[a-z]/)) strength++;
                if (password.match(/[A-Z]/)) strength++;
                if (password.match(/[0-9]/)) strength++;
                if (password.match(/[^a-zA-Z0-9]/)) strength++;

                const strengthLevels = ['Rất yếu', 'Yếu', 'Trung bình', 'Tốt', 'Rất tốt'];
                const strengthClasses = ['weak', 'weak', 'fair', 'good', 'strong'];

                for (let i = 0; i < strength && i < strengthBars.length; i++) {
                    strengthBars[i].classList.add(strengthClasses[Math.min(strength - 1, 4)]);
                }

                strengthText.textContent = strength > 0 ? strengthLevels[Math.min(strength - 1, 4)] : 'Độ mạnh mật khẩu';
            }

            function checkPasswordRequirements(password) {
                const requirements = {
                    length: password.length >= 6,
                    uppercase: /[A-Z]/.test(password),
                    lowercase: /[a-z]/.test(password),
                    number: /[0-9]/.test(password),
                    special: /[^a-zA-Z0-9]/.test(password)
                };

                Object.keys(requirements).forEach(rule => {
                    const item = document.querySelector(`[data-rule="${rule}"]`);
                    if (item) {
                        if (requirements[rule]) {
                            item.classList.add('met');
                        } else {
                            item.classList.remove('met');
                        }
                    }
                });
            }

            // Button ripple effect
            const submitBtn = document.querySelector('.btn-primary-custom');
            if (submitBtn) {
                submitBtn.addEventListener('click', function(e) {
                    const ripple = this.querySelector('.btn-ripple');
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;

                    ripple.style.width = ripple.style.height = size + 'px';
                    ripple.style.left = x + 'px';
                    ripple.style.top = y + 'px';
                    ripple.classList.add('ripple-animate');

                    setTimeout(() => {
                        ripple.classList.remove('ripple-animate');
                    }, 600);
                });
            }

            // Form validation enhancement
            const form = document.querySelector('.password-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    const requiredFields = form.querySelectorAll('input[data-val-required]');
                    let isValid = true;

                    requiredFields.forEach(field => {
                        if (field.value.trim() === '') {
                            field.closest('.password-input-wrapper').classList.add('error');
                            isValid = false;
                        } else {
                            field.closest('.password-input-wrapper').classList.remove('error');
                        }
                    });

                    if (!isValid) {
                        e.preventDefault();
                        // Scroll to first error
                        const firstError = form.querySelector('.password-input-wrapper.error');
                        if (firstError) {
                            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                });
            }
        });
    </script>
}