@using Microsoft.EntityFrameworkCore
@model ProjectEXE.ViewModel.ShopOrderViewModel.ShopOrderDetailViewModel
@{
    ViewData["Title"] = "Chi tiết đơn hàng #" + Model.OrderId;
}

<div class="container-fluid py-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-controller="ShopOrder" asp-action="Index">Quản lý đơn hàng shop</a></li>
            <li class="breadcrumb-item active" aria-current="page">Chi tiết đơn hàng #@Model.OrderId</li>
        </ol>
    </nav>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row">
        <!-- Thông tin đơn hàng -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Thông tin đơn hàng #@Model.OrderId</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p><strong>Ngày đặt hàng:</strong> @Model.OrderDate.ToString("dd/MM/yyyy HH:mm")</p>
                            <p><strong>Cập nhật lần cuối:</strong> @Model.UpdatedAt.ToString("dd/MM/yyyy HH:mm")</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Trạng thái:</strong> <span class="badge @Model.StatusClass">@Model.StatusName</span></p>
                            @if (Model.StatusId == 5 && !string.IsNullOrEmpty(Model.CancelReason))
                            {
                                <p><strong>Lý do hủy:</strong> @Model.CancelReason</p>
                            }
                        </div>
                    </div>

                    <h5 class="border-bottom pb-2 mb-3">Sản phẩm</h5>
                    <div class="d-flex mb-4">
                        <img src="@Model.ProductImageUrl" class="rounded me-3" style="width: 100px; height: 100px; object-fit: cover;">
                        <div>
                            <h5 class="mb-1">@Model.ProductName</h5>
                            <p class="text-danger fw-bold mb-1">@Model.Price.ToString("N0")₫</p>
                            <p class="text-muted small mb-0">Danh mục: @Model.Category | Tình trạng: @Model.Condition</p>
                            <a asp-controller="Product" asp-action="ProductDetails" asp-route-id="@Model.ProductId" target="_blank" class="btn btn-sm btn-outline-primary mt-2">
                                <i class="fas fa-external-link-alt me-1"></i>Xem sản phẩm
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Thông tin khách hàng và cập nhật trạng thái -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Thông tin khách hàng</h5>
                </div>
                <div class="card-body">
                    <p><i class="fas fa-user me-2"></i><strong>Họ tên:</strong> @Model.BuyerName</p>
                    <p><i class="fas fa-phone-alt me-2"></i><strong>Số điện thoại:</strong> @Model.BuyerPhone</p>
                    <p><i class="fas fa-envelope me-2"></i><strong>Email:</strong> @Model.BuyerEmail</p>
                    <p><i class="fas fa-map-marker-alt me-2"></i><strong>Địa chỉ:</strong> @Model.BuyerAddress</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Cập nhật trạng thái</h5>
                </div>
                <div class="card-body">
                    <form asp-action="UpdateStatus" method="post">
                        <input type="hidden" name="OrderId" value="@Model.OrderId" />
                        @Html.AntiForgeryToken()

                        <div class="mb-3">
                            <label class="form-label">Trạng thái đơn hàng</label>
                            <select class="form-select" name="StatusId" id="statusSelect">
                                @foreach (var status in await new ProjectEXE.Services.Implementations.ShopOrderService(new RevaContext(new DbContextOptions<RevaContext>())).GetOrderStatusesAsync())
                                {
                                    <option value="@status.Key" selected="@(Model.StatusId == status.Key)">@status.Value</option>
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Ghi chú</label>
                            <textarea class="form-control" name="Notes" rows="2" placeholder="Nhập ghi chú nếu có"></textarea>
                        </div>

                        <div id="cancelReasonGroup" class="mb-3 @(Model.StatusId == 5 ? "" : "d-none")">
                            <label class="form-label">Lý do hủy đơn</label>
                            <textarea class="form-control" name="CancelReason" rows="2" placeholder="Nhập lý do hủy đơn hàng">@Model.CancelReason</textarea>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-save me-2"></i>Cập nhật trạng thái
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Hiển thị/ẩn trường lý do hủy dựa trên trạng thái
            $('#statusSelect').on('change', function() {
                var statusId = $(this).val();
                if (statusId == 5) {
                    $('#cancelReasonGroup').removeClass('d-none');
                } else {
                    $('#cancelReasonGroup').addClass('d-none');
                }
            });
        });
    </script>
}